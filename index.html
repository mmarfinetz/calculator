<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plumbing Job Quote Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .calculator-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .calculator-body {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 25px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .input-section:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }

        .input-label {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .input-help {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            margin-left: 40px;
            font-style: italic;
        }

        .input-wrapper {
            position: relative;
            margin-left: 40px;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
        }

        input[type="number"] {
            width: 100%;
            padding: 15px 15px 15px 45px;
            font-size: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .quick-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-left: 40px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            background: #e8eaf6;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            color: #667eea;
            font-weight: 500;
        }

        .quick-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .quick-btn.active {
            background: #667eea;
            color: white;
        }

        /* Time Type Toggle */
        .time-type-toggle {
            display: flex;
            gap: 10px;
            margin-left: 40px;
            margin-bottom: 15px;
        }

        .time-type-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }

        .time-type-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .time-type-btn:hover:not(.active) {
            border-color: #667eea;
        }

        /* Pipe Calculator Styles */
        .pipe-calculator {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 15px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .pipe-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .pipe-header:hover {
            background: rgba(33, 150, 243, 0.1);
        }

        .pipe-title {
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pipe-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
            color: #1976d2;
        }

        .pipe-toggle.open {
            transform: rotate(180deg);
        }

        .pipe-content {
            display: none;
            padding: 20px;
            border-top: 2px dashed #2196f3;
            background: white;
        }

        .pipe-content.show {
            display: block;
        }

        .pipe-input-group {
            margin-bottom: 15px;
        }

        .pipe-input-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .pipe-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .pipe-input-group input:focus {
            outline: none;
            border-color: #2196f3;
        }

        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .difficulty-btn {
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .difficulty-btn:hover {
            border-color: #2196f3;
            transform: translateY(-2px);
        }

        .difficulty-btn .diff-name {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .difficulty-btn .diff-price {
            font-size: 12px;
            color: #666;
        }

        .difficulty-btn.easy { border-left: 4px solid #4caf50; }
        .difficulty-btn.standard { border-left: 4px solid #2196f3; }
        .difficulty-btn.tight { border-left: 4px solid #ff9800; }
        .difficulty-btn.hard { border-left: 4px solid #f44336; }

        .pipe-note {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            color: #856404;
            margin-top: 15px;
        }

        /* Results Section */
        .results-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            margin-top: 30px;
        }

        .breakdown {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: none;
        }

        .breakdown.show {
            display: block;
        }

        .show-breakdown-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 20px;
            width: 100%;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .show-breakdown-btn:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        .show-breakdown-btn.active {
            background: white;
            color: #667eea;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .breakdown-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .breakdown-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .breakdown-value {
            font-size: 16px;
            font-weight: 600;
        }

        .profit-item {
            background: rgba(76, 175, 80, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .profit-item .breakdown-label {
            color: #a5d6a7;
        }

        .profit-item .breakdown-value {
            color: #a5d6a7;
        }

        .final-price {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .final-price-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .final-price-amount {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            line-height: 1;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .warning-icon {
            font-size: 24px;
        }

        .reset-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .reset-button:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        /* Quick Reference */
        .reference {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            font-size: 13px;
            color: #666;
        }

        .reference h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reference-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 20px;
        }

        .reference-item {
            display: flex;
            justify-content: space-between;
        }

        .reference-item strong {
            color: #667eea;
        }

        /* Setup Section */
        .setup-section {
            background: #e3f2fd;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #2196f3;
        }

        .setup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .setup-title {
            font-size: 14px;
            font-weight: 600;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setup-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
            color: #1976d2;
        }

        .setup-toggle.open {
            transform: rotate(180deg);
        }

        .setup-content {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #2196f3;
        }

        .setup-content.show {
            display: block;
        }

        .setup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .setup-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .setup-label {
            font-size: 11px;
            font-weight: 600;
            color: #1976d2;
            text-transform: uppercase;
        }

        .setup-input {
            padding: 8px;
            border: 2px solid #90caf9;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .setup-input:focus {
            outline: none;
            border-color: #2196f3;
        }

        .calculated-rates {
            margin-top: 15px;
            padding: 12px;
            background: #fff3cd;
            border-radius: 8px;
            border: 2px solid #ffc107;
        }

        .calculated-rates .rate-label {
            font-weight: 600;
            color: #856404;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .calculated-rates .rate-values {
            font-size: 14px;
            color: #856404;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 24px;
            }

            .final-price-amount {
                font-size: 36px;
            }

            .quick-buttons {
                margin-left: 0;
            }

            .input-wrapper {
                margin-left: 0;
            }

            .input-help {
                margin-left: 0;
            }

            .time-type-toggle {
                margin-left: 0;
            }

            .reference-grid {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body {
                background: white;
            }
            .calculator-container {
                box-shadow: none;
            }
            .reset-button, .setup-section, .pipe-calculator {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="header">
            <h1>Plumbing Quote Calculator</h1>
            <p>Marfinetz Plumbing Company</p>
        </div>

        <div class="calculator-body">
            <!-- Setup Section (Collapsible) -->
            <div class="setup-section">
                <div class="setup-header" onclick="toggleSetup()">
                    <div class="setup-title">
                        <span>Settings</span>
                    </div>
                    <span class="setup-toggle" id="setupToggle">&#9660;</span>
                </div>
                <div class="setup-content" id="setupContent">
                    <div class="setup-grid">
                        <div class="setup-item">
                            <label class="setup-label">F - Fixed Costs</label>
                            <input type="number" id="setupF" class="setup-input" value="7799" step="1" min="0" onchange="saveSetup()">
                        </div>
                        <div class="setup-item">
                            <label class="setup-label">P - Target Profit</label>
                            <input type="number" id="setupP" class="setup-input" value="2000" step="100" min="0" onchange="saveSetup()">
                        </div>
                        <div class="setup-item">
                            <label class="setup-label">D - Billable Days</label>
                            <input type="number" id="setupD" class="setup-input" value="20" step="1" min="1" onchange="saveSetup()">
                        </div>
                        <div class="setup-item">
                            <label class="setup-label">Sc - Capacity</label>
                            <input type="number" id="setupSc" class="setup-input" value="0.90" step="0.01" min="0.1" max="1.0" onchange="saveSetup()">
                        </div>
                        <div class="setup-item">
                            <label class="setup-label">Cb - Base Cushion</label>
                            <input type="number" id="setupCb" class="setup-input" value="0.10" step="0.01" min="0" onchange="saveSetup()">
                        </div>
                        <div class="setup-item">
                            <label class="setup-label">Cm - Materials</label>
                            <input type="number" id="setupCm" class="setup-input" value="0.10" step="0.01" min="0" onchange="saveSetup()">
                        </div>
                        <div class="setup-item">
                            <label class="setup-label">f - Card Fee</label>
                            <input type="number" id="setupF_fee" class="setup-input" value="0.03" step="0.001" min="0" onchange="saveSetup()">
                        </div>
                        <div class="setup-item">
                            <label class="setup-label">Hday - Hours/Day</label>
                            <input type="number" id="setupHday" class="setup-input" value="8" step="0.5" min="1" onchange="saveSetup()">
                        </div>
                    </div>
                    <div class="calculated-rates">
                        <div class="rate-label">Calculated Rates:</div>
                        <div class="rate-values">
                            B<sub>day</sub> = <span id="calcBday">$598.83</span> |
                            B<sub>hour</sub> = <span id="calcBhour">$74.85</span> |
                            Posted: <span id="calcPosted">$79/hr</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Per-Foot Pipe Calculator (Collapsible) -->
            <div class="pipe-calculator">
                <div class="pipe-header" onclick="togglePipeCalc()">
                    <div class="pipe-title">
                        <span>Per-Foot Pipe Pricing</span>
                    </div>
                    <span class="pipe-toggle" id="pipeToggle">&#9660;</span>
                </div>
                <div class="pipe-content" id="pipeContent">
                    <div class="pipe-input-group">
                        <label for="pipeFeet">Pipe Length (feet):</label>
                        <input type="number" id="pipeFeet" step="1" min="0" placeholder="Enter feet of pipe">
                    </div>
                    <div class="pipe-input-group">
                        <label for="pipeMaterialCost">Material Cost per Foot ($):</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="pipeMaterialCost" step="1" min="0" value="12" placeholder="12" style="flex: 1;">
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                <button class="quick-btn" onclick="document.getElementById('pipeMaterialCost').value=8" style="padding: 6px 10px; font-size: 12px;">$8</button>
                                <button class="quick-btn" onclick="document.getElementById('pipeMaterialCost').value=12" style="padding: 6px 10px; font-size: 12px;">$12</button>
                                <button class="quick-btn" onclick="document.getElementById('pipeMaterialCost').value=18" style="padding: 6px 10px; font-size: 12px;">$18</button>
                                <button class="quick-btn" onclick="document.getElementById('pipeMaterialCost').value=25" style="padding: 6px 10px; font-size: 12px;">$25</button>
                            </div>
                        </div>
                    </div>
                    <div class="pipe-input-group">
                        <label>Difficulty Level:</label>
                        <div class="difficulty-grid">
                            <button class="difficulty-btn easy" onclick="calculatePipeJob(0.25, 'Easy')">
                                <span class="diff-name">Easy</span>
                                <span class="diff-price">~$33/ft</span>
                            </button>
                            <button class="difficulty-btn standard" onclick="calculatePipeJob(0.50, 'Standard')">
                                <span class="diff-name">Standard</span>
                                <span class="diff-price">~$52/ft</span>
                            </button>
                            <button class="difficulty-btn tight" onclick="calculatePipeJob(0.75, 'Tight')">
                                <span class="diff-name">Tight</span>
                                <span class="diff-price">~$72/ft</span>
                            </button>
                            <button class="difficulty-btn hard" onclick="calculatePipeJob(1.0, 'Hard')">
                                <span class="diff-name">Hard</span>
                                <span class="diff-price">~$91/ft</span>
                            </button>
                        </div>
                    </div>
                    <div class="pipe-note">
                        <strong>Note:</strong> Per-foot pricing includes $319 minimum base + materials. Adjust $/ft above for different pipe types (2" PVC ~$12, copper ~$25).
                    </div>
                </div>
            </div>

            <!-- Time Input -->
            <div class="input-section">
                <div class="input-label">
                    <span class="step-number">1</span>
                    Time for the job
                </div>
                <div class="input-help">Select input type, then enter time</div>

                <div class="time-type-toggle">
                    <button class="time-type-btn active" id="hoursBtn" onclick="setTimeType('hours')">Crew Hours</button>
                    <button class="time-type-btn" id="daysBtn" onclick="setTimeType('days')">Crew Days</button>
                </div>

                <div class="input-wrapper">
                    <span class="input-icon" id="timeIcon">&#9201;</span>
                    <input type="number" id="time" placeholder="0" step="0.5" min="0">
                </div>

                <div class="quick-buttons">
                    <button class="quick-btn" onclick="setQuickTime(0.5)">1/2 Day</button>
                    <button class="quick-btn" onclick="setQuickTime(1)">Full Day</button>
                    <button class="quick-btn" onclick="setQuickTime(1.5)">1.5 Days</button>
                    <button class="quick-btn" onclick="setQuickTime(2)">2 Days</button>
                </div>
            </div>

            <!-- Materials Input -->
            <div class="input-section">
                <div class="input-label">
                    <span class="step-number">2</span>
                    Cost of materials/parts
                </div>
                <div class="input-help">Your cost - 10% cushion added automatically</div>
                <div class="input-wrapper">
                    <span class="input-icon">$</span>
                    <input type="number" id="materials" placeholder="0" step="10" min="0">
                </div>
                <div class="quick-buttons">
                    <button class="quick-btn" onclick="setMaterials(25)">$25</button>
                    <button class="quick-btn" onclick="setMaterials(50)">$50</button>
                    <button class="quick-btn" onclick="setMaterials(100)">$100</button>
                    <button class="quick-btn" onclick="setMaterials(200)">$200</button>
                    <button class="quick-btn" onclick="setMaterials(500)">$500</button>
                </div>
            </div>

            <!-- Results -->
            <div class="results-section" id="results" style="display: none;">
                <button class="show-breakdown-btn" id="breakdownBtn" onclick="toggleBreakdown()">
                    Show Detailed Breakdown
                </button>

                <div class="breakdown" id="breakdown">
                    <div class="breakdown-item">
                        <span class="breakdown-label">Job effort</span>
                        <span class="breakdown-value" id="jobEffort">-</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Labor (time x base rate)</span>
                        <span class="breakdown-value" id="laborCost">$0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Materials (cost + 10%)</span>
                        <span class="breakdown-value" id="materialsCost">$0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Subtotal (before fee)</span>
                        <span class="breakdown-value" id="subtotalAmount">$0</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Card processing (3%)</span>
                        <span class="breakdown-value" id="cardFeeAmount">$0</span>
                    </div>
                    <div class="breakdown-item profit-item">
                        <span class="breakdown-label">Expected Profit (target)</span>
                        <span class="breakdown-value" id="profitAmount">$0</span>
                    </div>
                    <div class="breakdown-item" style="background: rgba(33, 150, 243, 0.3); padding: 12px; border-radius: 8px; margin-top: 10px;">
                        <span class="breakdown-label" style="color: #90caf9;">True Margin (incl. cushions)</span>
                        <span class="breakdown-value" style="color: #90caf9;" id="trueMarginAmount">$0</span>
                    </div>
                </div>

                <div class="final-price">
                    <div class="final-price-label">Quote This Price</div>
                    <div class="final-price-amount" id="finalPrice">$0</div>
                </div>

                <div class="warning" id="minimumWarning">
                    <span class="warning-icon">&#9888;</span>
                    <div>
                        <strong>Minimum service charge applied ($319)</strong><br>
                        <small>Covers up to 0.5 day / 4 crew-hours</small>
                    </div>
                </div>
            </div>

            <button class="reset-button" onclick="resetCalculator()">Clear & Start Over</button>

            <!-- Quick Reference -->
            <div class="reference">
                <h3>Quick Reference</h3>
                <div class="reference-grid">
                    <div class="reference-item">
                        <span>Minimum:</span>
                        <strong>$319</strong>
                    </div>
                    <div class="reference-item">
                        <span>Hourly:</span>
                        <strong>$79/crew-hr</strong>
                    </div>
                    <div class="reference-item">
                        <span>Materials:</span>
                        <strong>Cost x 1.10</strong>
                    </div>
                    <div class="reference-item">
                        <span>Card fee:</span>
                        <strong>3% (included)</strong>
                    </div>
                    <div class="reference-item">
                        <span>Pipe (easy):</span>
                        <strong>~$33/ft</strong>
                    </div>
                    <div class="reference-item">
                        <span>Pipe (hard):</span>
                        <strong>~$91/ft</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // PRICING MODEL - UPDATED TO MATCH SPEC
        // ============================================
        const MINIMUM_CHARGE = 319;  // Minimum service call
        const MINIMUM_DAYS = 0.5;    // 0.5 day = 4 crew-hours

        let timeType = 'hours';  // 'hours' or 'days'

        // Load setup from localStorage or use correct defaults
        function loadSetup() {
            const saved = localStorage.getItem('pricingModelSetup');
            if (saved) {
                const params = JSON.parse(saved);
                document.getElementById('setupF').value = params.F ?? 7799;
                document.getElementById('setupP').value = params.P ?? 2000;
                document.getElementById('setupD').value = params.D ?? 20;
                document.getElementById('setupSc').value = params.Sc ?? 0.90;
                document.getElementById('setupCb').value = params.Cb ?? 0.10;
                document.getElementById('setupCm').value = params.Cm ?? 0.10;
                document.getElementById('setupF_fee').value = params.f ?? 0.03;
                document.getElementById('setupHday').value = params.Hday ?? 8;
            }
            updateCalculatedRates();
        }

        // Save setup to localStorage
        function saveSetup() {
            const params = getSetupParams();
            localStorage.setItem('pricingModelSetup', JSON.stringify(params));
            updateCalculatedRates();
            calculatePrice();
        }

        // Get current setup parameters
        function getSetupParams() {
            return {
                F: parseFloat(document.getElementById('setupF').value) || 7799,
                P: parseFloat(document.getElementById('setupP').value) || 2000,
                D: parseFloat(document.getElementById('setupD').value) || 20,
                Sc: parseFloat(document.getElementById('setupSc').value) || 0.90,
                Cb: parseFloat(document.getElementById('setupCb').value) || 0.10,
                Cm: parseFloat(document.getElementById('setupCm').value) || 0.10,
                f: parseFloat(document.getElementById('setupF_fee').value) || 0.03,
                Hday: parseFloat(document.getElementById('setupHday').value) || 8
            };
        }

        // Calculate B_day and B_hour
        function calculateRates(params) {
            // B_day = (1 + C_b)(F + P) / (S_c * D)
            const Bday = (1 + params.Cb) * (params.F + params.P) / (params.Sc * params.D);
            const Bhour = Bday / params.Hday;
            return { Bday, Bhour };
        }

        // Update displayed calculated rates
        function updateCalculatedRates() {
            const params = getSetupParams();
            const { Bday, Bhour } = calculateRates(params);

            // Posted hourly rate (with fee baked in, rounded up to nice number)
            const postedHourly = Math.ceil(Bhour / (1 - params.f));

            document.getElementById('calcBday').textContent = `$${Bday.toFixed(2)}`;
            document.getElementById('calcBhour').textContent = `$${Bhour.toFixed(2)}`;
            document.getElementById('calcPosted').textContent = `$${postedHourly}/hr`;
        }

        // Toggle setup section
        function toggleSetup() {
            const content = document.getElementById('setupContent');
            const toggle = document.getElementById('setupToggle');
            content.classList.toggle('show');
            toggle.classList.toggle('open');
        }

        // Toggle pipe calculator
        function togglePipeCalc() {
            const content = document.getElementById('pipeContent');
            const toggle = document.getElementById('pipeToggle');
            content.classList.toggle('show');
            toggle.classList.toggle('open');
        }

        // Set time input type
        function setTimeType(type) {
            timeType = type;
            const hoursBtn = document.getElementById('hoursBtn');
            const daysBtn = document.getElementById('daysBtn');
            const timeInput = document.getElementById('time');

            if (type === 'hours') {
                hoursBtn.classList.add('active');
                daysBtn.classList.remove('active');
                timeInput.placeholder = 'Crew hours (e.g., 4)';
                timeInput.step = '0.5';
            } else {
                hoursBtn.classList.remove('active');
                daysBtn.classList.add('active');
                timeInput.placeholder = 'Crew days (e.g., 0.5)';
                timeInput.step = '0.125';
            }
            calculatePrice();
        }

        // Set quick time (always in days, converts based on mode)
        function setQuickTime(days) {
            const params = getSetupParams();
            const timeInput = document.getElementById('time');

            if (timeType === 'hours') {
                timeInput.value = days * params.Hday;
            } else {
                timeInput.value = days;
            }

            // Visual feedback
            document.querySelectorAll('.quick-buttons .quick-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            setTimeout(() => event.target.classList.remove('active'), 300);

            calculatePrice();
        }

        // Quick set materials
        function setMaterials(value) {
            document.getElementById('materials').value = value;
            calculatePrice();
        }

        // Calculate pipe job and populate fields
        function calculatePipeJob(hoursPerFoot, difficultyName) {
            const feet = parseFloat(document.getElementById('pipeFeet').value) || 0;
            if (feet === 0) {
                alert('Please enter the pipe length in feet');
                return;
            }

            const params = getSetupParams();
            const totalHours = feet * hoursPerFoot;
            const totalDays = totalHours / params.Hday;
            const materialsPerFoot = parseFloat(document.getElementById('pipeMaterialCost').value) || 12;
            const totalMaterials = feet * materialsPerFoot;

            // Ensure minimum
            const billableDays = Math.max(totalDays, MINIMUM_DAYS);

            // Set values based on current time type
            if (timeType === 'hours') {
                document.getElementById('time').value = Math.max(4, totalHours);
            } else {
                document.getElementById('time').value = billableDays;
            }
            document.getElementById('materials').value = totalMaterials;

            calculatePrice();

            // Scroll to results
            setTimeout(() => {
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Round UP to next number ending in 9
        function roundToNext9(price) {
            const ceiled = Math.ceil(price);
            const lastDigit = ceiled % 10;
            return ceiled + (9 - lastDigit);
        }

        // Toggle breakdown visibility
        function toggleBreakdown() {
            const breakdown = document.getElementById('breakdown');
            const button = document.getElementById('breakdownBtn');

            if (breakdown.classList.contains('show')) {
                breakdown.classList.remove('show');
                button.classList.remove('active');
                button.textContent = 'Show Detailed Breakdown';
            } else {
                breakdown.classList.add('show');
                button.classList.add('active');
                button.textContent = 'Hide Detailed Breakdown';
            }
        }

        // ============================================
        // MAIN CALCULATION FUNCTION
        // ============================================
        function calculatePrice() {
            const timeInput = parseFloat(document.getElementById('time').value) || 0;
            const materialsCost = parseFloat(document.getElementById('materials').value) || 0;

            if (timeInput === 0 && materialsCost === 0) {
                document.getElementById('results').style.display = 'none';
                return;
            }

            const params = getSetupParams();
            const { Bday, Bhour } = calculateRates(params);

            // Convert input to days
            let days = timeType === 'hours' ? timeInput / params.Hday : timeInput;
            let displayHours = timeType === 'hours' ? timeInput : timeInput * params.Hday;

            // Apply minimum billing (0.5 day = 4 crew-hours)
            const billableDays = Math.max(days, MINIMUM_DAYS);
            const minimumApplied = days > 0 && days < MINIMUM_DAYS;

            // Calculate components
            // Labor = B_day * d_j
            const laborCost = billableDays * Bday;

            // Materials = (1 + C_m) * M
            const materialsWithCushion = (1 + params.Cm) * materialsCost;

            // Subtotal (before fee)
            const subtotal = laborCost + materialsWithCushion;

            // ALWAYS apply card fee: Price = subtotal / (1 - f)
            const rawTotal = subtotal / (1 - params.f);
            const cardFee = rawTotal - subtotal;

            // Round UP to next $x9
            let finalPrice = roundToNext9(rawTotal);

            // Ensure minimum charge
            if (finalPrice < MINIMUM_CHARGE && (days > 0 || materialsCost > 0)) {
                finalPrice = MINIMUM_CHARGE;
            }

            // Calculate expected profit for this job
            // Profit per day = P / (Sc * D)
            const profitPerDay = params.P / (params.Sc * params.D);
            const jobProfit = billableDays * profitPerDay;
            const profitPercent = (jobProfit / finalPrice * 100).toFixed(1);

            // Calculate TRUE margin (including cushions)
            // True operating cost = F / (Sc * D) per day + raw materials + card fee
            const fixedCostPerDay = params.F / (params.Sc * params.D);
            const trueOperatingCost = (billableDays * fixedCostPerDay) + materialsCost + cardFee;
            const trueProfit = finalPrice - trueOperatingCost;
            const trueMarginPercent = (trueProfit / finalPrice * 100).toFixed(1);

            // Update display
            const jobEffortText = timeType === 'hours'
                ? `${displayHours} hrs = ${billableDays.toFixed(2)} days`
                : `${billableDays.toFixed(2)} days`;

            document.getElementById('jobEffort').textContent = jobEffortText;
            document.getElementById('laborCost').textContent = `$${laborCost.toFixed(0)}`;
            document.getElementById('materialsCost').textContent = `$${materialsWithCushion.toFixed(0)}`;
            document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(0)}`;
            document.getElementById('cardFeeAmount').textContent = `$${cardFee.toFixed(0)}`;
            document.getElementById('profitAmount').textContent = `$${jobProfit.toFixed(0)} (${profitPercent}%)`;
            document.getElementById('trueMarginAmount').textContent = `$${trueProfit.toFixed(0)} (${trueMarginPercent}%)`;
            document.getElementById('finalPrice').textContent = `$${finalPrice.toLocaleString()}`;

            // Show/hide minimum warning
            document.getElementById('minimumWarning').style.display =
                (minimumApplied || finalPrice === MINIMUM_CHARGE) ? 'flex' : 'none';

            // Show results
            document.getElementById('results').style.display = 'block';
        }

        // Reset function
        function resetCalculator() {
            document.getElementById('time').value = '';
            document.getElementById('materials').value = '';
            document.getElementById('pipeFeet').value = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('breakdown').classList.remove('show');
            document.getElementById('breakdownBtn').classList.remove('active');
            document.getElementById('breakdownBtn').textContent = 'Show Detailed Breakdown';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSetup();

            // Add event listeners for real-time calculation
            document.getElementById('time').addEventListener('input', calculatePrice);
            document.getElementById('materials').addEventListener('input', calculatePrice);

            // Prevent negative numbers
            document.getElementById('time').addEventListener('change', function() {
                if (this.value < 0) this.value = 0;
            });
            document.getElementById('materials').addEventListener('change', function() {
                if (this.value < 0) this.value = 0;
            });
            document.getElementById('pipeFeet').addEventListener('change', function() {
                if (this.value < 0) this.value = 0;
            });

            // Enter key support
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        calculatePrice();
                    }
                });
            });
        });
    </script>
</body>
</html>
